name: AI Collaboration Notes System

# Trigger when any AI leaves a note for another AI
on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  issues:
    types: [opened, edited]

permissions:
  contents: read
  pull-requests: write
  issues: write

env:
  ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
  OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
  GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
  XAI_API_KEY: ${{ secrets.XAI_API_KEY }}

jobs:
  # Detect which AI should respond to the note
  route-note:
    runs-on: ubuntu-latest
    outputs:
      target_ai: ${{ steps.parse.outputs.target }}
      context: ${{ steps.parse.outputs.context }}
      should_respond: ${{ steps.parse.outputs.should_respond }}
    steps:
      - name: Parse AI note tags
        id: parse
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.comment?.body ||
                         context.payload.issue?.body ||
                         context.payload.review?.body || '';

            // AI note format: @ai:<model> <message>
            // Examples:
            //   @ai:claude Please review the architecture
            //   @ai:gemini Check security implications
            //   @ai:codex Suggest optimizations
            //   @ai:grok Find edge cases

            const tagPattern = /@ai:(claude|gemini|codex|grok|all)\b/i;
            const match = body.match(tagPattern);

            if (!match) {
              core.setOutput('should_respond', 'false');
              return;
            }

            const target = match[1].toLowerCase();
            const context = body.replace(tagPattern, '').trim();

            core.setOutput('target', target);
            core.setOutput('context', context);
            core.setOutput('should_respond', 'true');

            console.log(`AI note detected: @ai:${target}`);
            console.log(`Context: ${context}`);

  # Claude responds to notes
  claude-respond:
    needs: route-note
    if: needs.route-note.outputs.should_respond == 'true' && (needs.route-note.outputs.target_ai == 'claude' || needs.route-note.outputs.target_ai == 'all')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Get conversation context
        id: context
        uses: actions/github-script@v7
        with:
          script: |
            // Get all previous comments for context
            let comments = [];

            if (context.payload.issue) {
              const result = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.issue.number
              });
              comments = result.data.map(c => `${c.user.login}: ${c.body}`).join('\n\n');
            } else if (context.payload.pull_request) {
              const result = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number
              });
              comments = result.data.map(c => `${c.user.login}: ${c.body}`).join('\n\n');
            }

            core.setOutput('history', comments.substring(0, 10000)); // Limit size

      - name: Claude processes note
        id: response
        uses: actions/github-script@v7
        with:
          script: |
            const note = `${{ needs.route-note.outputs.context }}`;
            const history = `${{ steps.context.outputs.history }}`;

            const response = await fetch('https://api.anthropic.com/v1/messages', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'x-api-key': process.env.ANTHROPIC_API_KEY,
                'anthropic-version': '2023-06-01'
              },
              body: JSON.stringify({
                model: 'claude-sonnet-4-20250514',
                max_tokens: 1500,
                system: `You are Claude, an AI assistant participating in a collaborative code review.
                         Other AI models may have left notes for you. Review their input and add your perspective.
                         If you need input from another AI, tag them with @ai:<model>.
                         Available models: @ai:gemini, @ai:codex, @ai:grok
                         Be concise and constructive.`,
                messages: [{
                  role: 'user',
                  content: `Previous discussion:\n${history}\n\nNew note for you:\n${note}\n\nPlease respond.`
                }]
              })
            });

            const data = await response.json();
            core.setOutput('response', data.content[0].text);

      - name: Post Claude's response
        uses: actions/github-script@v7
        with:
          script: |
            const response = `${{ steps.response.outputs.response }}`;
            const issueNumber = context.payload.issue?.number ||
                               context.payload.pull_request?.number;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: `### ðŸ§  Claude's Response\n\n${response}\n\n---\n*Tag another AI: @ai:gemini @ai:codex @ai:grok*`
            });

  # Gemini responds to notes
  gemini-respond:
    needs: route-note
    if: needs.route-note.outputs.should_respond == 'true' && (needs.route-note.outputs.target_ai == 'gemini' || needs.route-note.outputs.target_ai == 'all')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Get conversation context
        id: context
        uses: actions/github-script@v7
        with:
          script: |
            let comments = [];
            const issueNumber = context.payload.issue?.number || context.payload.pull_request?.number;

            if (issueNumber) {
              const result = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber
              });
              comments = result.data.map(c => `${c.user.login}: ${c.body}`).join('\n\n');
            }
            core.setOutput('history', comments.substring(0, 10000));

      - name: Gemini processes note
        id: response
        uses: actions/github-script@v7
        with:
          script: |
            const note = `${{ needs.route-note.outputs.context }}`;
            const history = `${{ steps.context.outputs.history }}`;

            const response = await fetch(
              `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-pro:generateContent?key=${process.env.GOOGLE_API_KEY}`,
              {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  systemInstruction: {
                    parts: [{
                      text: `You are Gemini, an AI assistant specializing in security and documentation review.
                             You're collaborating with other AIs (Claude, Codex, Grok) on code review.
                             If you need another AI's input, tag them: @ai:claude, @ai:codex, @ai:grok
                             Focus on security vulnerabilities and documentation gaps.`
                    }]
                  },
                  contents: [{
                    parts: [{
                      text: `Previous discussion:\n${history}\n\nNew note for you:\n${note}\n\nPlease respond.`
                    }]
                  }],
                  generationConfig: { maxOutputTokens: 1500 }
                })
              }
            );

            const data = await response.json();
            core.setOutput('response', data.candidates[0].content.parts[0].text);

      - name: Post Gemini's response
        uses: actions/github-script@v7
        with:
          script: |
            const response = `${{ steps.response.outputs.response }}`;
            const issueNumber = context.payload.issue?.number || context.payload.pull_request?.number;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: `### ðŸ”’ Gemini's Response\n\n${response}\n\n---\n*Tag another AI: @ai:claude @ai:codex @ai:grok*`
            });

  # Codex/GPT-4 responds to notes
  codex-respond:
    needs: route-note
    if: needs.route-note.outputs.should_respond == 'true' && (needs.route-note.outputs.target_ai == 'codex' || needs.route-note.outputs.target_ai == 'all')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Get conversation context
        id: context
        uses: actions/github-script@v7
        with:
          script: |
            let comments = [];
            const issueNumber = context.payload.issue?.number || context.payload.pull_request?.number;

            if (issueNumber) {
              const result = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber
              });
              comments = result.data.map(c => `${c.user.login}: ${c.body}`).join('\n\n');
            }
            core.setOutput('history', comments.substring(0, 10000));

      - name: Codex processes note
        id: response
        uses: actions/github-script@v7
        with:
          script: |
            const note = `${{ needs.route-note.outputs.context }}`;
            const history = `${{ steps.context.outputs.history }}`;

            const response = await fetch('https://api.openai.com/v1/chat/completions', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${process.env.OPENAI_API_KEY}`
              },
              body: JSON.stringify({
                model: 'gpt-4-turbo-preview',
                max_tokens: 1500,
                messages: [
                  {
                    role: 'system',
                    content: `You are Codex/GPT-4, an AI assistant specializing in code quality and best practices.
                              You're collaborating with other AIs (Claude, Gemini, Grok) on code review.
                              If you need another AI's input, tag them: @ai:claude, @ai:gemini, @ai:grok
                              Focus on code patterns, maintainability, and testing.`
                  },
                  {
                    role: 'user',
                    content: `Previous discussion:\n${history}\n\nNew note for you:\n${note}\n\nPlease respond.`
                  }
                ]
              })
            });

            const data = await response.json();
            core.setOutput('response', data.choices[0].message.content);

      - name: Post Codex's response
        uses: actions/github-script@v7
        with:
          script: |
            const response = `${{ steps.response.outputs.response }}`;
            const issueNumber = context.payload.issue?.number || context.payload.pull_request?.number;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: `### ðŸ’» Codex's Response\n\n${response}\n\n---\n*Tag another AI: @ai:claude @ai:gemini @ai:grok*`
            });

  # Grok responds to notes
  grok-respond:
    needs: route-note
    if: needs.route-note.outputs.should_respond == 'true' && (needs.route-note.outputs.target_ai == 'grok' || needs.route-note.outputs.target_ai == 'all')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Get conversation context
        id: context
        uses: actions/github-script@v7
        with:
          script: |
            let comments = [];
            const issueNumber = context.payload.issue?.number || context.payload.pull_request?.number;

            if (issueNumber) {
              const result = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber
              });
              comments = result.data.map(c => `${c.user.login}: ${c.body}`).join('\n\n');
            }
            core.setOutput('history', comments.substring(0, 10000));

      - name: Grok processes note
        id: response
        uses: actions/github-script@v7
        with:
          script: |
            const note = `${{ needs.route-note.outputs.context }}`;
            const history = `${{ steps.context.outputs.history }}`;

            const response = await fetch('https://api.x.ai/v1/chat/completions', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${process.env.XAI_API_KEY}`
              },
              body: JSON.stringify({
                model: 'grok-beta',
                max_tokens: 1500,
                messages: [
                  {
                    role: 'system',
                    content: `You are Grok, an AI that thinks differently and finds unconventional issues.
                              You're collaborating with other AIs (Claude, Gemini, Codex) on code review.
                              If you need another AI's input, tag them: @ai:claude, @ai:gemini, @ai:codex
                              Focus on edge cases, creative solutions, and things others might miss.
                              Don't be afraid to be a bit witty.`
                  },
                  {
                    role: 'user',
                    content: `Previous discussion:\n${history}\n\nNew note for you:\n${note}\n\nPlease respond.`
                  }
                ]
              })
            });

            const data = await response.json();
            core.setOutput('response', data.choices[0].message.content);

      - name: Post Grok's response
        uses: actions/github-script@v7
        with:
          script: |
            const response = `${{ steps.response.outputs.response }}`;
            const issueNumber = context.payload.issue?.number || context.payload.pull_request?.number;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: `### ðŸš€ Grok's Response\n\n${response}\n\n---\n*Tag another AI: @ai:claude @ai:gemini @ai:codex*`
            });
