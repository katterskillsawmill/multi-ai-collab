name: AI Collaboration Notes System

# Trigger when any AI leaves a note for another AI
on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

permissions:
  contents: read
  pull-requests: write
  issues: write

env:
  ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
  OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
  GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
  XAI_API_KEY: ${{ secrets.XAI_API_KEY }}

jobs:
  # Detect which AI should respond to the note
  route-note:
    runs-on: ubuntu-latest
    outputs:
      target_ai: ${{ steps.parse.outputs.target }}
      context: ${{ steps.parse.outputs.context }}
      should_respond: ${{ steps.parse.outputs.should_respond }}
      issue_number: ${{ steps.parse.outputs.issue_number }}
    steps:
      - name: Parse AI note tags
        id: parse
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.comment?.body ||
                         context.payload.issue?.body ||
                         context.payload.review?.body || '';

            // AI note format: @ai:<model> <message>
            const tagPattern = /@ai:(claude|gemini|gpt4|codex|grok|all)\b/i;
            const match = body.match(tagPattern);

            if (!match) {
              core.setOutput('should_respond', 'false');
              return;
            }

            let target = match[1].toLowerCase();
            // Normalize codex -> gpt4
            if (target === 'codex') target = 'gpt4';

            const noteContext = body.replace(tagPattern, '').trim();
            const issueNumber = context.payload.issue?.number ||
                               context.payload.pull_request?.number ||
                               context.issue?.number;

            core.setOutput('target', target);
            core.setOutput('context', noteContext);
            core.setOutput('should_respond', 'true');
            core.setOutput('issue_number', issueNumber);

            console.log(`AI note detected: @ai:${target}`);

  # Claude responds to notes
  claude-respond:
    needs: route-note
    if: needs.route-note.outputs.should_respond == 'true' && (needs.route-note.outputs.target_ai == 'claude' || needs.route-note.outputs.target_ai == 'all')
    runs-on: ubuntu-latest
    steps:
      - name: Get conversation context
        id: context
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = ${{ needs.route-note.outputs.issue_number }};
            let comments = [];

            try {
              const result = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                per_page: 100
              });
              comments = result.data.map(c => `${c.user.login}: ${c.body}`).join('\n\n');
            } catch (e) {
              console.log('Error fetching comments:', e.message);
            }

            core.setOutput('history', comments.substring(0, 8000));

      - name: Claude processes note
        id: response
        uses: actions/github-script@v7
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        with:
          script: |
            const note = `${{ needs.route-note.outputs.context }}`;
            const history = `${{ steps.context.outputs.history }}`;

            if (!process.env.ANTHROPIC_API_KEY) {
              core.setOutput('response', 'Claude API key not configured');
              core.setOutput('success', 'false');
              return;
            }

            try {
              const response = await fetch('https://api.anthropic.com/v1/messages', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'x-api-key': process.env.ANTHROPIC_API_KEY,
                  'anthropic-version': '2023-06-01'
                },
                body: JSON.stringify({
                  model: 'claude-sonnet-4-20250514',
                  max_tokens: 1500,
                  system: `You are Claude, an AI assistant participating in collaborative code review. Other AI models may have left notes for you. Review their input and add your perspective. If you need input from another AI, tag them: @ai:gemini @ai:gpt4 @ai:grok. Be concise and constructive.`,
                  messages: [{
                    role: 'user',
                    content: `Previous discussion:\n${history}\n\nNew note for you:\n${note}\n\nPlease respond.`
                  }]
                })
              });

              if (!response.ok) {
                throw new Error(`API error: ${response.status}`);
              }

              const data = await response.json();
              if (data.content && data.content[0]) {
                core.setOutput('response', data.content[0].text);
                core.setOutput('success', 'true');
              } else {
                throw new Error('Empty response');
              }
            } catch (error) {
              console.log('Claude error:', error.message);
              core.setOutput('response', `Error: ${error.message}`);
              core.setOutput('success', 'false');
            }

      - name: Post Claude's response
        if: steps.response.outputs.success == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const response = `${{ steps.response.outputs.response }}`;
            const issueNumber = ${{ needs.route-note.outputs.issue_number }};

            const body = [
              '### ðŸ§  Claude',
              '',
              response,
              '',
              '*Tag another AI: `@ai:gemini` `@ai:gpt4` `@ai:grok`*'
            ].join('\n');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: body
            });

  # GPT-4 responds to notes
  gpt4-respond:
    needs: route-note
    if: needs.route-note.outputs.should_respond == 'true' && (needs.route-note.outputs.target_ai == 'gpt4' || needs.route-note.outputs.target_ai == 'codex' || needs.route-note.outputs.target_ai == 'all')
    runs-on: ubuntu-latest
    steps:
      - name: Get conversation context
        id: context
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = ${{ needs.route-note.outputs.issue_number }};
            let comments = [];

            try {
              const result = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                per_page: 100
              });
              comments = result.data.map(c => `${c.user.login}: ${c.body}`).join('\n\n');
            } catch (e) {
              console.log('Error fetching comments:', e.message);
            }

            core.setOutput('history', comments.substring(0, 8000));

      - name: GPT-4 processes note
        id: response
        uses: actions/github-script@v7
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        with:
          script: |
            const note = `${{ needs.route-note.outputs.context }}`;
            const history = `${{ steps.context.outputs.history }}`;

            if (!process.env.OPENAI_API_KEY) {
              core.setOutput('response', 'OpenAI API key not configured');
              core.setOutput('success', 'false');
              return;
            }

            try {
              const response = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'Authorization': `Bearer ${process.env.OPENAI_API_KEY}`
                },
                body: JSON.stringify({
                  model: 'gpt-4o',
                  max_tokens: 1500,
                  messages: [
                    {
                      role: 'system',
                      content: `You are GPT-4, an AI assistant specializing in code quality and best practices. You're collaborating with other AIs (Claude, Gemini, Grok) on code review. If you need another AI's input, tag them: @ai:claude @ai:gemini @ai:grok. Focus on code patterns, maintainability, and testing.`
                    },
                    {
                      role: 'user',
                      content: `Previous discussion:\n${history}\n\nNew note for you:\n${note}\n\nPlease respond.`
                    }
                  ]
                })
              });

              if (!response.ok) {
                throw new Error(`API error: ${response.status}`);
              }

              const data = await response.json();
              if (data.choices && data.choices[0]) {
                core.setOutput('response', data.choices[0].message.content);
                core.setOutput('success', 'true');
              } else {
                throw new Error('Empty response');
              }
            } catch (error) {
              console.log('GPT-4 error:', error.message);
              core.setOutput('response', `Error: ${error.message}`);
              core.setOutput('success', 'false');
            }

      - name: Post GPT-4's response
        if: steps.response.outputs.success == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const response = `${{ steps.response.outputs.response }}`;
            const issueNumber = ${{ needs.route-note.outputs.issue_number }};

            const body = [
              '### ðŸ’» GPT-4',
              '',
              response,
              '',
              '*Tag another AI: `@ai:claude` `@ai:gemini` `@ai:grok`*'
            ].join('\n');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: body
            });

  # Gemini responds to notes
  gemini-respond:
    needs: route-note
    if: needs.route-note.outputs.should_respond == 'true' && (needs.route-note.outputs.target_ai == 'gemini' || needs.route-note.outputs.target_ai == 'all')
    runs-on: ubuntu-latest
    steps:
      - name: Get conversation context
        id: context
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = ${{ needs.route-note.outputs.issue_number }};
            let comments = [];

            try {
              const result = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                per_page: 100
              });
              comments = result.data.map(c => `${c.user.login}: ${c.body}`).join('\n\n');
            } catch (e) {
              console.log('Error fetching comments:', e.message);
            }

            core.setOutput('history', comments.substring(0, 8000));

      - name: Gemini processes note
        id: response
        uses: actions/github-script@v7
        env:
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
        with:
          script: |
            const note = `${{ needs.route-note.outputs.context }}`;
            const history = `${{ steps.context.outputs.history }}`;

            if (!process.env.GOOGLE_API_KEY) {
              core.setOutput('response', 'Google API key not configured');
              core.setOutput('success', 'false');
              return;
            }

            try {
              const response = await fetch(
                `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-pro:generateContent?key=${process.env.GOOGLE_API_KEY}`,
                {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({
                    systemInstruction: {
                      parts: [{
                        text: `You are Gemini, an AI specializing in security and documentation review. You're collaborating with other AIs (Claude, GPT-4, Grok). If you need another AI's input, tag them: @ai:claude @ai:gpt4 @ai:grok. Focus on security vulnerabilities and documentation gaps.`
                      }]
                    },
                    contents: [{
                      parts: [{
                        text: `Previous discussion:\n${history}\n\nNew note for you:\n${note}\n\nPlease respond.`
                      }]
                    }],
                    generationConfig: { maxOutputTokens: 1500 }
                  })
                }
              );

              if (!response.ok) {
                throw new Error(`API error: ${response.status}`);
              }

              const data = await response.json();
              if (data.candidates && data.candidates[0]) {
                core.setOutput('response', data.candidates[0].content.parts[0].text);
                core.setOutput('success', 'true');
              } else {
                throw new Error('Empty response');
              }
            } catch (error) {
              console.log('Gemini error:', error.message);
              core.setOutput('response', `Error: ${error.message}`);
              core.setOutput('success', 'false');
            }

      - name: Post Gemini's response
        if: steps.response.outputs.success == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const response = `${{ steps.response.outputs.response }}`;
            const issueNumber = ${{ needs.route-note.outputs.issue_number }};

            const body = [
              '### ðŸ”’ Gemini',
              '',
              response,
              '',
              '*Tag another AI: `@ai:claude` `@ai:gpt4` `@ai:grok`*'
            ].join('\n');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: body
            });

  # Grok responds to notes
  grok-respond:
    needs: route-note
    if: needs.route-note.outputs.should_respond == 'true' && (needs.route-note.outputs.target_ai == 'grok' || needs.route-note.outputs.target_ai == 'all')
    runs-on: ubuntu-latest
    steps:
      - name: Get conversation context
        id: context
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = ${{ needs.route-note.outputs.issue_number }};
            let comments = [];

            try {
              const result = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                per_page: 100
              });
              comments = result.data.map(c => `${c.user.login}: ${c.body}`).join('\n\n');
            } catch (e) {
              console.log('Error fetching comments:', e.message);
            }

            core.setOutput('history', comments.substring(0, 8000));

      - name: Grok processes note
        id: response
        uses: actions/github-script@v7
        env:
          XAI_API_KEY: ${{ secrets.XAI_API_KEY }}
        with:
          script: |
            const note = `${{ needs.route-note.outputs.context }}`;
            const history = `${{ steps.context.outputs.history }}`;

            if (!process.env.XAI_API_KEY) {
              core.setOutput('response', 'X.AI API key not configured');
              core.setOutput('success', 'false');
              return;
            }

            try {
              const response = await fetch('https://api.x.ai/v1/chat/completions', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'Authorization': `Bearer ${process.env.XAI_API_KEY}`
                },
                body: JSON.stringify({
                  model: 'grok-2-latest',
                  max_tokens: 1500,
                  messages: [
                    {
                      role: 'system',
                      content: `You are Grok, an AI that thinks differently and finds unconventional issues. You're collaborating with other AIs (Claude, GPT-4, Gemini). If you need another AI's input, tag them: @ai:claude @ai:gpt4 @ai:gemini. Focus on edge cases, creative solutions, and things others might miss. Be slightly witty.`
                    },
                    {
                      role: 'user',
                      content: `Previous discussion:\n${history}\n\nNew note for you:\n${note}\n\nPlease respond.`
                    }
                  ]
                })
              });

              if (!response.ok) {
                throw new Error(`API error: ${response.status}`);
              }

              const data = await response.json();
              if (data.choices && data.choices[0]) {
                core.setOutput('response', data.choices[0].message.content);
                core.setOutput('success', 'true');
              } else {
                throw new Error('Empty response');
              }
            } catch (error) {
              console.log('Grok error:', error.message);
              core.setOutput('response', `Error: ${error.message}`);
              core.setOutput('success', 'false');
            }

      - name: Post Grok's response
        if: steps.response.outputs.success == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const response = `${{ steps.response.outputs.response }}`;
            const issueNumber = ${{ needs.route-note.outputs.issue_number }};

            const body = [
              '### ðŸš€ Grok',
              '',
              response,
              '',
              '*Tag another AI: `@ai:claude` `@ai:gpt4` `@ai:gemini`*'
            ].join('\n');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: body
            });
